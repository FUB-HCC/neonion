{% extends "base.html" %}

{% load staticfiles %}

{% block title %}Annotator{% endblock %}

{% block stylesheets %}
    <link rel="stylesheet" href="{% static 'css/annotator.neonion.css' %}" type="text/css" media="screen" />
    <link rel="stylesheet" href="{% static 'css/annotator.min.css' %}" type="text/css" media="screen" />
{% endblock %}


{% block content %}
<div class="bg bg-10"></div>

<div class="units-row">

    <div class="unit-10 annotator-nav">
        <nav class="nav">
            <ul>
                <li><a href="/annotator"><span class="fa fa-home fa-fw" title="MyNeonion"></span></a></li>
                <li><span class="fa fa-expand fa-fw" id="enableFullscreen" title="Fullscreen"></span></li>
                <li><span class="fa fa-bar-chart-o fa-fw deactivated" title="Analyze"></span></li>
                <li>&nbsp;</li>
                <ul id="annotationSets">
                    <li><span class="fa fa-users fa-fw active" title="Persons" annotationSet="p"></span></li>
                    <li><span class="fa fa-university fa-fw" title="Institutions" annotationSet="i"> </span></li>
                    <li><span class="fa fa-book fa-fw" title="References" annotationSet="r"></span></li>
                </ul>
                <li id="help-link"><span class="fa fa-question fa-fw" title="Help"></span></li>
            </ul>
        </nav>
    </div>

    <div class="unit-centered unit-60">
        <div class="units-row">
            <div id="annotationArea" class="panel panel-default" >
                <div id="documentTitle" class="panel-heading"></div>
                <div id="documentText" class="panel-body"><span class="fa fa-spinner fa-spin"></span> Loading...</div>
            </div>
        </div>
        <!-- <div class="units-row">
            <button class="btn btn-green" id="document-save" >
                Speichern
            </button>
        </div> -->
    </div>

</div>

{% endblock %}

{% block scripts %}
    <script type="text/javascript" src="{% static 'js/annotator.min.js' %}"></script>
    <script type="text/javascript" src="{% static 'js/annotator.neonion.js' %}"></script>

    <script language="javascript">

        var data = {
            resourceName : "{{ doc_id }}",
            document : null
        };

        $(document).ready(function() {
            loadDocument(config.resourceName, config);
            loadAnnotationSets(config);

            // attach event handler
            $('#document-save').click(function () {
               // saveDocument(config);
            });

            $( '#annotationSets li span' ).each( function(){
                $( this ).click( function(){
                    $( this ).toggleClass( 'active' );
                    console.log( checkAnnotationSetSelection() );
                });
            });

            $( '#enableFullscreen' ).click(function(){
                enableFullscreen( document.getElementById( 'annotationArea' ) );
            });


        });

        function checkAnnotationSetSelection(){
            var activeAnnotationSets = [];
            $( '#annotationSets li span' ).each( function(){
                if( $( this ).hasClass('active') ){
                    activeAnnotationSets.push( $( this ).attr( 'annotationSet' ) );
                }
            });
            return activeAnnotationSets;
        }

        // Find the right method, call on correct element
        function enableFullscreen(element) {
          if(element.requestFullscreen) {
            element.requestFullscreen();
          } else if(element.mozRequestFullScreen) {
            element.mozRequestFullScreen();
          } else if(element.webkitRequestFullscreen) {
            element.webkitRequestFullscreen();
          } else if(element.msRequestFullscreen) {
            element.msRequestFullscreen();
          }
        }


        function loadDocument (resourceName, config) {
            // load document from loomp
            jQuery.ajax(
            {
                url: config.server + config.service.get + "?uri=" + config.uriPrefix + data.resourceName,
                type: 'GET',
                crossDomain: true,
                dataType: 'json'
            }
            ).done(function(response) {
                data.document = response;
                $("#documentTitle").html(data.document.title);
                $("#documentText").html(data.document.content);
                $("#documentText").annotator()
                .annotator('addPlugin', 'Neonion');

                restoreAnnotations();
                $('#document-save').show();
            });
        }


        /* Restores the annotation from markup */
        function restoreAnnotations() {
            /*
            $("#documentText span[about]").each(function() {
                $(this).attr("class", "annotator-hl");
            });
            */
        }

        function loadAnnotationSets(config) {
            // TODO
        }

        function saveDocument(config) {
            var contentNode = Annotator._instances[0].wrapper[0].childNodes[0];
            data.document.content = contentNode.outerHTML;
            //console.log(data.document.content);
            jQuery.ajax(
            {
                url: config.server + config.service.save,
                type: 'POST',
                data : { "data" : JSON.stringify(data.document), fmt : "JSON" }
            }).success(function(data, textStatus, jqXHR) {
                console.log(data);

                $("#alert-saved").addClass("in");
                window.setTimeout(function() {
                    $("#alert-saved").removeClass("in");
                    $("#alert-saved").addClass("out");
                }, 3000);
            }).error(function(jqXHR, textStatus, errorThrown) {
                console.log(errorThrown);
            });
        }

    </script>
{% endblock %}