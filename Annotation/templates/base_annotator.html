{% extends "base.html" %}

{% load staticfiles %}

{% block title %}Annotator{% endblock %}

{% block stylesheets %}
    <link rel="stylesheet" href="{% static 'css/annotator.neonion.css' %}" type="text/css" media="screen" />
    <link rel="stylesheet" href="{% static 'css/annotator.min.css' %}" type="text/css" media="screen" />
{% endblock %}

{% block top %}
    <div class="bg bg-10"></div>
{% endblock %}

{% block bottom_left %}
    <div class="unit-10 annotator-nav">
        <nav class="nav">
            <ul>
                <li><a href="/annotator"><span class="fa fa-home fa-fw" title="MyNeonion"></span></a></li>
                <li><span class="fa fa-expand fa-fw" id="enableFullscreen" title="Fullscreen"></span></li>
                <li><span class="fa fa-bar-chart-o fa-fw deactivated" title="Analyze"></span></li>
                <li>&nbsp;</li>
                <ul id="annotationSets">
                    <li><span class="fa fa-users fa-fw active" title="Persons" annotationSet="p"></span></li>
                    <li><span class="fa fa-university fa-fw" title="Institutions" annotationSet="i"> </span></li>
                    <li><span class="fa fa-book fa-fw" title="References" annotationSet="r"></span></li>
                </ul>
                <li id="help-link"><span class="fa fa-question fa-fw" title="Help"></span></li>
            </ul>
        </nav>
    </div>
{% endblock %}

{% block bottom_right %}
    <div class="unit-centered unit-60">
        <div id="annotator_menu">
           <ul class="forms-list">
                <li><input type="checkbox" id="user_1"><label for="user_1">John Doe</label></li>
                <li><input type="checkbox" id="user_2"><label for="user_2">Max Mustermann</label></li>
                <li><input type="checkbox" id="user_3"><label for="user_3">Emine Kartal</label></li>
                <li><input type="checkbox" id="user_4"><label for="user_4">Irina Bulgakowa</label></li>
            </ul>
            <a href="#" id="scoll_to_latest_annotation"><i class="fa fa-arrow-circle-down"></i> scroll to last annotation</a>
        </div>
        <div class="units-row">
            <div id="annotationArea" class="panel panel-default" >
                <div id="documentTitle" class="panel-heading big"></div>
                <div id="documentText" class="panel-body"><span class="fa fa-spinner fa-spin"></span> Loading...</div>
            </div>
        </div>
    </div>
{% endblock %}


{% block scripts %}
    <script type="text/javascript" src="{% static 'js/annotator.min.js' %}"></script>
    <script type="text/javascript" src="{% static 'js/annotator.neonion.js' %}"></script>
    <script type="text/javascript" src="{% static 'js/annotator.store.min.js' %}"></script>
    <script type="text/javascript" src="{% static 'js/moment.js' %}"></script>
    <script type="text/javascript" src="{% static 'js/jquery-ui-1.11.1.custom.min.js' %}"></script>

    <script language="javascript">

        var data = {
            resourceName : "{{ doc_id }}",
            document : null
        };

        var randomshift = Math.floor((Math.random() * 360) + 1);
        function makeColor(colorNum, colors){
            if (colors < 1) colors = 1; // defaults to one color - avoid divide by zero
            return randomshift + ( colorNum * (360 / colors) ) % 360;
        }


        $(document).ready(function() {
            loadDocument(config.scms.resourceName);

            $( '#annotationSets li span' ).each( function(){
                $( this ).click( function(){
                    $( this ).toggleClass( 'active' );
                    console.log( checkAnnotationSetSelection() );
                });
            });

            $( '#enableFullscreen' ).click(function(){
                enableFullscreen( document.getElementById( 'annotationArea' ) );
            });

            var i = 0
            var totalcolors = 4;
            $( '#annotator_menu li' ).each(function(){
                    var color = "hsla( " + makeColor(i, totalcolors) + ", 100%, 50%, 0.3 )";
                    $( this )[0].style.backgroundColor = color;
                    i = i + 1;
            });

            $( '#scoll_to_latest_annotation' ).click(function(){
                var target = $('.annotator-hl').last(); /* TODO: replace with correct identifiert for last annotation */
                $('html, body').stop().animate(
                  { 'scrollTop': target.offset().top },
                  1000,
                  'easeInOutQuart',
                  function (){
                    window.location.hash = target;
                  }
                );
                /* blink for more attention */
                for(i=0;i<2;i++) {
                    $(target).fadeTo('slow', 0.5).fadeTo('slow', 1.0);
                  }
            });

            $('#annotator_menu :checkbox').click(function() {
                if ($(this).is(':checked')) {
                    console.log('check'); /* TODO: show annotations of this user */
                } else {
                    console.log('uncheck'); /* TODO: hide annotations of this user */
                }
            });


        });

        function checkAnnotationSetSelection(){
            var activeAnnotationSets = [];
            $( '#annotationSets li span' ).each( function(){
                if( $( this ).hasClass('active') ){
                    activeAnnotationSets.push( $( this ).attr( 'annotationSet' ) );
                }
            });
            return activeAnnotationSets;
        }

        // Find the right method, call on correct element
        function enableFullscreen(element) {
          if(element.requestFullscreen) {
            element.requestFullscreen();
          } else if(element.mozRequestFullScreen) {
            element.mozRequestFullScreen();
          } else if(element.webkitRequestFullscreen) {
            element.webkitRequestFullscreen();
          } else if(element.msRequestFullscreen) {
            element.msRequestFullscreen();
          }
        }

        function loadDocument (resourceName) {
            // load document from loomp
            jQuery.ajax(
            {
                url: sprintf(config.scms.server + config.scms.service.get, { uri : config.scms.uriPrefix + data.resourceName }),
                type: 'GET',
                crossDomain: true,
                dataType: 'json'
            }
            ).done(function(response) {
                // TODO move loading document to server template
                data.document = response;
                $("#documentTitle").html(data.document.title);
                $("#documentText").html(data.document.content);
                $("#documentText").annotator()
                .annotator('addPlugin', 'Neonion', {
                    whoamiUrl: config.neonion.whoami,
                    search : config.search
                })
                .annotator('addPlugin', 'Store', {
                    // The endpoint of the store on your server.
                    prefix : config.store.server,
                    // Attach the uri of the current page to all annotations to allow search.
                    annotationData: { 'uri' : data.resourceName },
                    loadFromSearch: { 'uri' : data.resourceName }
                });

                // get contributors and last annotation
                /*console.log(Annotator.Plugin.Neonion.prototype.getContributors());
                console.log(Annotator.Plugin.Neonion.prototype.getLastAnnotation('andre.breitenfeld@fu-berlin.de'));
                Annotator.Plugin.Neonion.prototype.getUserAnnotations("user.email").forEach(function(entry) {
                    Annotator.Plugin.Neonion.prototype.hideAnnotation(entry);
                });*/

            });
        }
        /*
        function loadAnnotationSets() {
            // TODO
            jQuery.ajax({
                url: sprintf(config.scms.server + config.scms.service.getAll, { type : config.scms.uri.annotationSet }),
                type: 'GET',
                crossDomain: true,
                dataType: 'json'
            }).done(function(response) {
                //console.log(response);
            });
        }
        */
    </script>
{% endblock %}