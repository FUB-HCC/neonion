{% extends "base.html" %}

{% load staticfiles %}

{% block title %}Annotator{% endblock %}

{% block stylesheets %}
    <link rel="stylesheet" href="{% static 'css/annotator.min.css' %}" type="text/css" media="screen" />
    <link rel="stylesheet" href="{% static 'css/annotator.neonion.css' %}" type="text/css" media="screen" />
{% endblock %}


{% block content %}
<div class="bg bg-10"></div>

<div class="units-row">

    <div class="unit-10 annotator-nav">
        <nav class="nav">
            <ul>
                <li><a href="/annotator">My Neonion</a></li>
                <li><span>Fullscreen</span></li>
                <li><span>Analyze</span></li>
                <hr/>
                <li><a href="#" class="annotation-set as-active">Person</a></li>
                <li><span>Institution</span></li>
                <li><span>Reference</span></li>
            </ul>
        </nav>
    </div>

    <div class="unit-centered unit-60">
        <div class="units-row">
            <div id="annotationArea" class="panel panel-default" >
                <h2 id="documentTitle" class="panel-heading"></h2>
                <div id="documentText" class="panel-body">Loading...</div>
            </div>

        </div>
        <div class="units-row">
            <button class="btn btn-green" id="document-save" >
                Speichern
            </button>
        </div>
    </div>

</div>

{% endblock %}

{% block scripts %}
    <script type="text/javascript" src="{% static 'js/annotator.min.js' %}"></script>
    <script type="text/javascript" src="{% static 'js/annotator.neonion.js' %}"></script>

    <script language="javascript">

        var data = {
            resourceName : "{{ doc_id }}",
            document : null
        };

        $(document).ready(function() {
            loadDocument(config.resourceName, config);
            loadAnnotationSets(config);

            // attach event handler
            $('#document-save').click(function () {
               // saveDocument(config);
            });

        });

        function loadDocument (resourceName, config) {
            // load document from loomp
            jQuery.ajax(
            {
                url: config.server + config.service.get + "?uri=" + config.uriPrefix + data.resourceName,
                type: 'GET',
                crossDomain: true,
                dataType: 'json'
            }
            ).done(function(response) {
                data.document = response;
                $("#documentTitle").html(data.document.title);
                $("#documentText").html(data.document.content);
                $("#documentText").annotator()
                .annotator('addPlugin', 'Neonion');

                restoreAnnotations();
            });
        }


        /* Restores the annotation from markup */
        function restoreAnnotations() {
            /*
            $("#documentText span[about]").each(function() {
                $(this).attr("class", "annotator-hl");
            });
            */
        }

        function loadAnnotationSets(config) {
            // TODO
        }

        function saveDocument(config) {
            var contentNode = Annotator._instances[0].wrapper[0].childNodes[0];
            data.document.content = contentNode.outerHTML;
            //console.log(data.document.content);
            jQuery.ajax(
            {
                url: config.server + config.service.save,
                type: 'POST',
                data : { "data" : JSON.stringify(data.document), fmt : "JSON" }
            }).success(function(data, textStatus, jqXHR) {
                console.log(data);

                $("#alert-saved").addClass("in");
                window.setTimeout(function() {
                    $("#alert-saved").removeClass("in");
                    $("#alert-saved").addClass("out");
                }, 3000);
            }).error(function(jqXHR, textStatus, errorThrown) {
                console.log(errorThrown);
            });
        }

    </script>
{% endblock %}