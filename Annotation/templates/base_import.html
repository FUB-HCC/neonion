{% extends "base.html" %}

{% load staticfiles %}

{% block title %}Import{% endblock %}

{% block stylesheets %}{% endblock %}

{% block bottom_right %}
    <div class="unit-centered unit-60">
         <div class="units-row">
            <table id="document-table" class="table-simple"></table>
        </div> 
        <div class="units-row">
            <div class="panel panel-default" >
                <div >
                    <span id="spinner" style="display:none;"><span class="fa fa-spinner fa-spin"></span> Dokument wird geladen...</span>
                    <button style="display:none;" class="btn btn-green" id="document-import" >
                        Importieren
                    </button>
                </div>
                <div id="documentText" class="panel-body"></div>
            </div>
        </div>
    </div>
{% endblock %}

{% block scripts %}

    <script language="javascript">

        var docUris = [
            "Tätigkeitsberichte_der_MPG___Tätigkeitsbericht_der_MPG_1964-1965",
            "Tätigkeitsberichte_der_MPG___Tätigkeitsbericht_der_MPG_1958-1960",
            "Tätigkeitsberichte_der_MPG___MPG_Tätigkeitsbericht_1972-1973",
            "Tätigkeitsberichte_der_MPG___MPG_Tätigkeitsbericht_1968-1969",
            "Tätigkeitsberichte_der_MPG___MPG_Tätigkeitsbericht_1966-1967",
            "Tätigkeitsberichte_der_MPG___MPG_Tätigkeitsbericht_1964-1965",
            "Tätigkeitsberichte_der_MPG___MPG_Tätigkeitsbericht_1962-1963",
            "Tätigkeitsberichte_der_MPG___MPG_Tätigkeitsbericht_1961-1962",
            "Tätigkeitsberichte_der_MPG___MPG_Tätigkeitsbericht_1960-1961",
            "Tätigkeitsberichte_der_MPG___MPG_Tätigkeitsbericht_1958-1960",
            "Tätigkeitsberichte_der_MPG___MPG_Tätigkeitsbericht_1956-1958",
            "Tätigkeitsberichte_der_MPG___MPG_Tätigkeitsbericht_1954-1956",
            "Tätigkeitsberichte_der_MPG___MPG_Tätigkeitsbericht_1952-1954_Teil2",
            "Tätigkeitsberichte_der_MPG___MPG_Tätigkeitsbericht_1952-1954_Teil1",
            "Tätigkeitsberichte_der_MPG___MPG_Tätigkeitsbericht_1951-1952",
            "Tätigkeitsberichte_der_MPG___MPG_Tätigkeitsbericht_1946-51_Teil3",
            "Tätigkeitsberichte_der_MPG___MPG_Tätigkeitsbericht_1946-51_Teil2",
            "Tätigkeitsberichte_der_MPG___MPG_Tätigkeitsbericht_1946-51_Teil1"
        ]

        $(document).ready(function() {
            updateDocumentTable(docUris);

            $("#document-import").click(function() {

                var entityData = { 
                    uri : null , 
                    type : "http://vocab.loomp.org/model/ElementText",
                    dataCreated : 0, lastModified : 0, 
                    title : "Testdokument", content : "<span>TEST Inhalt</span>"
                };


                jQuery.ajax(
                {
                    url: config.scms.server + config.scms.service.create,
                    type: 'POST',
                    data : { "data" : JSON.stringify(entityData), fmt : "JSON" }
                }).success(function(data, textStatus, jqXHR) {
                    console.log(data);
                     //window.location = "/";
                }).error(function(jqXHR, textStatus, errorThrown) {
                    console.log(errorThrown);
                });

            });
        });

        function updateDocumentTable(entries) {
            // clear table
            $("#document-table").html("");
            // create docuement tabel
            $.each(entries, function(index, value) {
                $("#document-table").append(
                    "<tr><td></td><td class='element-cell'>" + 
                    "<a href='#'>" + value + "</a>" +
                    "<div class='document-list-buttons'><span onclick='retrieveDocument(\"" + value + "\")' class='fa fa-upload' title='Import'></span></div>" +
                    "</td></tr>"
                );
            });

        }

        function retrieveDocument(docUri) {
            $("#spinner").show();
            $("#document-import").hide();
            $("#documentText").html("");
            getPage(docUri, 0);
        }

        function getPage(docUri, pageNum) {
            jQuery.ajax({
                url: config.cms.server + config.cms.service.getPage + docUri + "&pn=" + pageNum,
                contentType: 'text/plain',
                type: 'GET',
                xhrFields : { withCredentials: false },
                headers: { },
                success : function(data, textStatus, jqXHR) {
                    $("#documentText").append(data);
                    getPage(docUri, pageNum + 1);
                },
                error : function(jqXHR, textStatus, errorThrown) {
                    if (jqXHR.status == 404) {
                        endRetrieveDocument();
                    }
                }
            });
        }

        function endRetrieveDocument() {
           $("#spinner").hide(); 
           $("#document-import").show();
        }

        function wrapContent(html) {
            return "<span xml:lang='de'>" + html + "</span>";
        }

    </script>
{% endblock %}