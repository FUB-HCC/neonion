{% extends "base.html" %}

{% load staticfiles %}

{% block title %}Annotator{% endblock %}
{% block page_id %}annotator{% endblock %}

{% block left %}
    <div class="sidebar">
        {% include "navigation_annotator.html" %}
    </div>
{% endblock %}

{% block content %}
<div ng-controller="AnnotatorCtrl" data-ng-init="setupAnnotator('{{ urn }}', '{{ request.user.email }}')">
    <div id="annotator_menu" style="display:none;position:fixed;">
        <ul id="annotator_contributors" class="forms-list"></ul>
        <a href="#" id="scoll_to_latest_annotation"><i class="fa fa-arrow-circle-down"></i> scroll to last
            annotation</a>
    </div>
    <div>
        <div id="document-frame" class="panel panel-default">
            <div id="document-title" class="panel-heading big">{{ title }}</div>
            <div id="document-body" class="panel-body">
                <div id="document-text">{% autoescape off %}{{ content }}{% endautoescape %}</div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
    <script type="text/javascript" src="{% static 'js/annotator.min.js' %}"></script>
    <script type="text/javascript" src="{% static 'js/annotator.neonion.js' %}"></script>
    <script type="text/javascript" src="{% static 'js/annotator.store.min.js' %}"></script>

    <script language="javascript">
        "use strict";

        /*var userColors = {};

        function makeColor(colorNum, colors) {
            if (colors < 1) colors = 1; // defaults to one color - avoid divide by zero
            return ( colorNum * (360 / colors) ) % 360;
        }*/

        function processTokenSet(tokenList) {
            var mergedToken = [];

            // Workaround Array in Array
            tokenList = tokenList.map(function(item) {
                item[0].offset.start -= 1;
                item[0].offset.end -= 1;
                return item[0];
            });

            if (tokenList.length > 0) {
                var plainText = $("#document-text").text();
                // sort by ascending by token start
                tokenList.sort(function (a, b) {
                    return a.offset.start - b.offset.start
                });
                var groups = {};
                // group token by type
                tokenList.map(function(item) {
                    if (!(item.type in groups)) {
                        groups[item.type] = [];
                    }
                    groups[item.type].push(item);
                    return item;
                });

                for (var key in groups) {
                    var currentToken = groups[key][0];
                    mergedToken.push(currentToken);
                    for (var i = 1; i < groups[key].length; i++) {
                        var token = groups[key][i];
                        // check if token are overlapping or separated by whitespace
                        if (
                                token.offset.start <= currentToken.offset.end ||
                                (Math.abs(token.offset.start - currentToken.offset.end) == 1 &&
                                plainText.charAt(Math.max(token.offset.start - 1, 0)) == " ")
                        ) {
                            // merge token
                            currentToken.offset.end = Math.max(currentToken.offset.end, token.offset.end);
                            currentToken.text = plainText.substring(currentToken.offset.start, currentToken.offset.end);
                        }
                        else {
                            currentToken = token;
                            mergedToken.push(currentToken);
                        }
                    }
                }
            }
            console.log(tokenList);
            console.log(mergedToken);
            return mergedToken;
        }

        $(document).ready(function () {
            $('#nav-anotate').click(function() {
                var span = $('#nav-anotate>span');
                if (!span.hasClass('fa-spin')) {
                    span.addClass('fa-spin');

                    // Post text to NER service
                    var model = "default";
                    var params = {
                        textURI: "{{ urn }}",
                        text: $("#document-text").text()
                    };
                    //console.log(params);
                    $.ajax({
                        type: "POST",
                        url: "{{ ner_url }}/models/" + model + "/recognize",
                        data: JSON.stringify(params),
                        dataType: "json",
                        contentType: "application/json; charset=utf-8",
                        success: function (data) {
                            processTokenSet(data.results);
                            span.removeClass('fa-spin');
                        },
                        error: function () {
                            span.removeClass('fa-spin');
                        }
                    });
                }
            });

            /*
             $('#nav-fullscreen').click(function(){
             enableFullscreen( document.getElementById( 'document-frame' ) );
             });

             $('#scoll_to_latest_annotation').click(function(){
             var annotation = Annotator.Plugin.Neonion.prototype.getLastAnnotation(annotator.plugins.Neonion.getUser().email);
             if (annotation) {
             var target = $(annotation.highlights[0]);
             $('html, body').stop().animate(
             { 'scrollTop': target.offset().top - 50 },
             1000,
             'easeInOutQuart'
             );
             // blink for more attention
             for(var i = 0; i < 2; i++) {
             $(target).fadeTo('slow', 0.5).fadeTo('slow', 1.0);
             }
             }
             return false;
             });

             $("#annotator_menu").on("click", "input[type=checkbox]", function() {
             var annotations = Annotator.Plugin.Neonion.prototype.getUserAnnotations($(this).val());
             if ($(this).is(':checked')) {
             annotations.forEach(function(item) {
             Annotator.Plugin.Neonion.prototype.showAnnotation(item);
             colorizeAnnotation(item);
             });
             } else {
             annotations.forEach(function(item) {
             Annotator.Plugin.Neonion.prototype.hideAnnotation(item);
             });
             }
             });
             */
        });

        /*function notifyEndpoint(annotation) {
            // clone annotation for stringify operation
            var copy = $.extend(true, {}, annotation);
            delete copy.highlights;
            $.post("{% url 'endpoint.views.annotation_created' %}", {
                annotation: JSON.stringify(copy),
                docUrn: "{{ urn }}",
                csrfmiddlewaretoken: $("input[name=csrfmiddlewaretoken]").val()
            });
        }

        function annotationChanged(annotation) {
            refreshContributors();
            colorizeAnnotation(annotation);
        }

        function colorizeAnnotation(annotation) {
            if (annotation.creator) {
                var color = userColors[annotation.creator.email];
                annotation.highlights.forEach(function (highlight) {
                    $(highlight).css("backgroundColor", color);
                });
            }
        }

        function refreshContributors() {
            var users = Annotator.Plugin.Neonion.prototype.getContributors();
            var items = [];

            users.forEach(function (user) {
                var lastAnnotation = Annotator.Plugin.Neonion.prototype.getLastAnnotation(user);
                var isoUpated = lastAnnotation.updated ? lastAnnotation.updated : new Date().toISOString();
                items.push({
                    user: user, // creator of annotation
                    updated: isoUpated // date when annotation was updated
                });
            });
            // sort according last activity
            items.sort(Annotator.Plugin.Neonion.prototype.comparator.compareByUpdated);
            items.reverse();

            var i = 0;
            var totalcolors = users.length;
            $('#annotator_contributors').html('');
            items.forEach(function (item) {
                var input = $("<input>").attr({
                    id: item.user,
                    value: item.user,
                    type: "checkbox",
                    checked: true
                });
                var listItem = $("<li>");
                if (!userColors[item.user]) {
                    userColors[item.user] = "hsla( " + makeColor(i++, totalcolors) + ", 100%, 50%, 0.3 )"
                }
                listItem.css("backgroundColor", userColors[item.user]);
                listItem.append(input);
                listItem.append("<label for='" + item.user + "'>" + item.user + " (" + moment(item.updated).fromNow(true) + ")" + "</label>");
                $('#annotator_contributors').append(listItem);
            });
        }*/

        /*
         // Find the right method, call on correct element
         function enableFullscreen(element) {
         if(element.requestFullscreen) {
         element.requestFullscreen();
         } else if(element.mozRequestFullScreen) {
         element.mozRequestFullScreen();
         } else if(element.webkitRequestFullscreen) {
         element.webkitRequestFullscreen();
         } else if(element.msRequestFullscreen) {
         element.msRequestFullscreen();
         }
         }
         */
    </script>
{% endblock %}