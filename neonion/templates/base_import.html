{% extends "base.html" %}

{% load staticfiles %}

{% block title %}Import{% endblock %}

{% block top_right %}{% endblock %}

{% block bottom_left %}
    <div class="unit-20">
        <nav class="nav">
            <ul>
                <li><a href="/annotator"><span class="fa fa-home fa-fw"></span>My Neonion</a></li>
                <li><a href="#" id="show_import_dialog" class="nav-active"><span class="fa fa-upload fa-fw"></span>Import</a></li>
                <li><span><span class="fa fa-pencil-square-o fa-fw"></span>Annotate</span></li>
                <li><span><span class="fa fa-bar-chart-o fa-fw"></span>Analyze</span></li>
                <!-- <li><a href="/accounts/profile"><span class="fa fa-child fa-fw"></span>Profile</a></li> -->
                <!-- <li><span><span class="fa fa-cogs fa-fw"></span>Settings</span></li> -->
                <li><a href="/accounts/logout"><span class="fa fa-sign-out fa-fw"></span>Logout</a></li>
                <li id="help-link"><span><span class="fa fa-question fa-fw"></span>Help</span></li>
            </ul>
        </nav>
    </div>
{% endblock %}

{% block bottom_right %}
<div class="unit-80" style="padding-top: 1em;">
    <p style="">Please select the files you want to import to your working space.</p>
    <div class="import-dialog" id="dialog-import">
        <ul id="document-import-list"></ul>
        <div class="units-row end dialog-foot">
            <button class="btn btn-small btn-outline mid cancel-btn">Cancel</button>
            <button class="btn btn-small btn-outline mid" onclick="importSelectedDocuments()">Import</button>
            <div id="document-cache" style="display:none"></div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}

<script language="javascript">

    var selectedDocs = [];
    var docList = [];

    $(document).ready(function() {
        $( "#document-import-list" ).selectable();

        $("#document-import").click(function() {
            $("#document-import").attr("disabled", true);
            importDocuemt();
        });

        refreshDocuments();
    });

    function refreshDocuments() {
        $.getJSON("/documents/import/list", function(data) {
            docList = data;
            // clear list
            $("#document-import-list").html('');
            // create docuement import list
            $.each(data, function(index, value) {
                // var item = new Option( value.urn, value.name );
                var item = $('<li></li>').attr( 'id', value.urn ).text( value.name ).attr('class','ui-widget-content');
                $('#document-import-list').append( item );
            });
        });
    }

    function importSelectedDocuments(){
        $( '.ui-selected' ).each(function() {
            selectedDocs.push( this.id );
        });
        importNextDocument();
    }

    function importNextDocument() {
        if (selectedDocs.length > 0) {
            var urn = selectedDocs.shift();
            console.log("Import document " + urn);
            $.get("/document/get/" + urn, function(data) {
                importDocuemt(urn, data);
                importNextDocument();
            });
        }
    }

    function importDocuemt(docUrn, content) {
        var title = docUrn;
        // get proper title
        docList.forEach(function(element, index, array) {
            if (element.urn == docUrn) {
                title = element.name;
            }
        });

        // assemble POST data
        var entityData = {
            uri : null ,
            title : title,
            content : content,
            type : config.scms.uri.elementText,
            dataCreated : 0, lastModified : 0,
        };

        jQuery.ajax({
            url: config.scms.server + config.scms.service.create,
            type: 'POST',
            data : { "data" : JSON.stringify(entityData), fmt : "JSON", csrfmiddlewaretoken : getCookie('csrftoken') }
        }).success(function(data, textStatus, jqXHR) {

        }).error(function(jqXHR, textStatus, errorThrown) {
            console.log(errorThrown);
        });
    }

    function getCookie(name) {
        var cookieValue = null;
        if (document.cookie && document.cookie != '') {
            var cookies = document.cookie.split(';');
            for (var i = 0; i < cookies.length; i++) {
                var cookie = jQuery.trim(cookies[i]);
                // Does this cookie string begin with the name we want?
                if (cookie.substring(0, name.length + 1) == (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

</script>

{% endblock %}